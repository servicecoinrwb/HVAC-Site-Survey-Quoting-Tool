<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HVACPro Survey Tool</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase Compat Library (Easier for single file HTML) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics-compat.js"></script>

    <style>
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white; }
            .break-inside-avoid { break-inside: avoid; }
            .break-before-page { break-before: page; }
        }
    </style>
</head>
<body class="bg-slate-100 min-h-screen font-sans text-slate-800">

    <div id="root"></div>

    <script type="text/babel">
        // --- ICONS (SVG Replacements for Lucide) ---
        const Icons = {
            Camera: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>,
            Trash2: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>,
            Plus: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>,
            Save: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>,
            FileText: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></svg>,
            Calculator: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="4" y="2" width="16" height="20" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></svg>,
            Settings: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            Users: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
            CheckCircle: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>,
            AlertTriangle: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></svg>,
            Printer: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>,
            ChevronDown: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 12 15 18 9"/></svg>,
            ChevronUp: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="18 15 12 9 6 15"/></svg>,
            Wrench: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>,
            LogIn: () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" x2="3" y1="12" y2="12"/></svg>,
            LogOut: () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>,
            Cloud: () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></svg>,
            Download: () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>,
            Loader: ({className}) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" x2="12" y1="2" y2="6"/><line x1="12" x2="12" y1="18" y2="22"/><line x1="4.93" x2="7.76" y1="4.93" y2="7.76"/><line x1="16.24" x2="19.07" y1="16.24" y2="19.07"/><line x1="2" x2="6" y1="12" y2="12"/><line x1="18" x2="22" y1="12" y2="12"/><line x1="4.93" x2="7.76" y1="19.07" y2="16.24"/><line x1="16.24" x2="19.07" y1="7.76" y2="4.93"/></svg>
        };

        const { useState, useEffect } = React;

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyB3nwP6M7veF9eD9hWW5Wy1zzv1pnnaU2M",
            authDomain: "hvac-site-survey-quoting-tool.firebaseapp.com",
            projectId: "hvac-site-survey-quoting-tool",
            storageBucket: "hvac-site-survey-quoting-tool.firebasestorage.app",
            messagingSenderId: "228511119722",
            appId: "1:228511119722:web:c2551e4ca7bd85842fcd13",
            measurementId: "G-69DC64LV90"
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();
        const googleProvider = new firebase.auth.GoogleAuthProvider();

        // --- COMMON DATA ---
        const COMMON_BRANDS = ["Carrier", "Trane", "Lennox", "York", "Daikin", "Rheem", "Ruud", "Goodman", "American Standard", "AAON", "Mitsubishi", "McQuay", "Bryant", "Heil"];
        
        const COMMON_FILTERS = [
            "16x20x1", "16x25x1", "20x20x1", "20x25x1", "14x20x1", "14x25x1", 
            "16x20x2", "16x25x2", "20x20x2", "20x25x2", "24x24x2", 
            "16x20x4", "16x25x4", "20x20x4", "20x25x4", "24x24x4"
        ];
        
        const COMMON_BELTS = [
            "A28", "A30", "A32", "A34", "A36", "A38", "A40", "A42", "A44", "A46", "A48", "A50", "A52", "A54", "A56", "A58", "A60",
            "B30", "B32", "B34", "B36", "B38", "B40", "B42", "B44", "B46", "B48", "B50", "B52", "B54", "B56", "B58", "B60",
            "AX32", "AX34", "AX36", "AX38", "AX40", "AX42", "AX46", "AX48", "AX50",
            "BX34", "BX36", "BX38", "BX40", "BX42", "BX44", "BX46", "BX48", "BX50"
        ];

        // --- COMPONENTS ---

        const Card = ({ children, className = "" }) => (
            <div className={`bg-white rounded-lg shadow-md border border-slate-200 overflow-hidden ${className}`}>
                {children}
            </div>
        );

        const Button = ({ children, onClick, variant = "primary", className = "", type="button", disabled = false }) => {
            const baseStyle = "px-4 py-2 rounded-md font-medium transition-colors flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed";
            const variants = {
                primary: "bg-blue-600 text-white hover:bg-blue-700",
                secondary: "bg-slate-100 text-slate-700 hover:bg-slate-200",
                danger: "bg-red-50 text-red-600 hover:bg-red-100",
                success: "bg-emerald-600 text-white hover:bg-emerald-700",
                outline: "border border-slate-300 text-slate-600 hover:bg-slate-50",
                google: "bg-white text-slate-700 border border-slate-300 hover:bg-slate-50"
            };
            return (
                <button type={type} onClick={onClick} disabled={disabled} className={`${baseStyle} ${variants[variant]} ${className}`}>
                    {children}
                </button>
            );
        };

        // --- CREATABLE SELECT COMPONENT ---
        const CreatableSelect = ({ options, value, onChange, placeholder, className }) => {
            const [isCustom, setIsCustom] = useState(!options.includes(value) && value !== "");

            // If the value comes in and it's not in the list (and not empty), ensure we show custom input
            useEffect(() => {
                if (value && !options.includes(value)) {
                    setIsCustom(true);
                }
            }, [value, options]);

            const handleSelectChange = (e) => {
                if (e.target.value === "__ADD_NEW__") {
                    setIsCustom(true);
                    onChange(""); 
                } else {
                    onChange(e.target.value);
                }
            };

            if (isCustom) {
                return (
                    <div className="flex gap-1 w-full">
                        <input 
                            type="text" 
                            className={className} 
                            value={value} 
                            onChange={(e) => onChange(e.target.value)} 
                            placeholder={`Custom ${placeholder}`}
                            autoFocus
                        />
                        <button 
                            onClick={() => { setIsCustom(false); onChange(""); }}
                            className="px-2 py-1 text-xs bg-slate-200 hover:bg-slate-300 rounded text-slate-600"
                            title="Back to list"
                        >
                            ✕
                        </button>
                    </div>
                );
            }

            return (
                <select 
                    className={className} 
                    value={value} 
                    onChange={handleSelectChange}
                >
                    <option value="">{placeholder || "Select..."}</option>
                    {options.map(opt => (
                        <option key={opt} value={opt}>{opt}</option>
                    ))}
                    <option disabled>──────────</option>
                    <option value="__ADD_NEW__" className="font-bold text-blue-600">+ Add New {placeholder}</option>
                </select>
            );
        };

        // --- UNIT CARD COMPONENT ---
        const UnitCard = ({ unit, updateUnit, updateNestedUnit, addItemToUnit, removeNestedItem, deleteUnit, handlePhotoUpload }) => {
            const [expanded, setExpanded] = useState(true);

            return (
                <Card className="mb-6 border-l-4 border-l-blue-600">
                    <div className="p-4 bg-slate-50 border-b flex justify-between items-center cursor-pointer" onClick={() => setExpanded(!expanded)}>
                        <div className="flex items-center gap-3">
                            <h3 className="font-bold text-lg text-slate-800">{unit.tag || 'New Unit'}</h3>
                            <span className="text-sm px-2 py-1 bg-blue-100 text-blue-800 rounded-full">{unit.tonnage} Ton</span>
                            {unit.driveType === 'Direct' && <span className="text-sm px-2 py-1 bg-green-100 text-green-800 rounded-full">Direct Drive</span>}
                        </div>
                        <div className="flex items-center gap-2">
                            <button onClick={(e) => { e.stopPropagation(); deleteUnit(unit.id); }} className="p-2 text-red-500 hover:bg-red-50 rounded"><Icons.Trash2/></button>
                            {expanded ? <Icons.ChevronUp/> : <Icons.ChevronDown/>}
                        </div>
                    </div>

                    {expanded && (
                        <div className="p-4 grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div className="space-y-4">
                                <h4 className="font-semibold text-slate-700 flex items-center gap-2"><Icons.Settings/> Unit Specs</h4>
                                <div className="grid grid-cols-2 gap-3">
                                    <div>
                                        <label className="text-xs font-medium text-slate-500">Brand</label>
                                        <CreatableSelect 
                                            className="w-full p-2 border rounded" 
                                            options={COMMON_BRANDS} 
                                            value={unit.brand} 
                                            onChange={(val) => updateUnit(unit.id, 'brand', val)} 
                                            placeholder="Brand" 
                                        />
                                    </div>
                                    <div>
                                        <label className="text-xs font-medium text-slate-500">Model #</label>
                                        <input type="text" className="w-full p-2 border rounded" value={unit.model} onChange={(e) => updateUnit(unit.id, 'model', e.target.value)} />
                                    </div>
                                    <div className="col-span-2">
                                        <label className="text-xs font-medium text-slate-500">Serial #</label>
                                        <input type="text" className="w-full p-2 border rounded" value={unit.serial} onChange={(e) => updateUnit(unit.id, 'serial', e.target.value)} />
                                    </div>
                                    <div>
                                        <label className="text-xs font-medium text-slate-500">Tonnage</label>
                                        <input type="number" className="w-full p-2 border rounded" value={unit.tonnage} onChange={(e) => updateUnit(unit.id, 'tonnage', e.target.value)} />
                                    </div>
                                    <div>
                                        <label className="text-xs font-medium text-slate-500">Refrigerant</label>
                                        <select className="w-full p-2 border rounded" value={unit.refrigerant} onChange={(e) => updateUnit(unit.id, 'refrigerant', e.target.value)}>
                                            <option>R-410A</option>
                                            <option>R-22</option>
                                            <option>R-407C</option>
                                            <option>R-32</option>
                                            <option>Other</option>
                                        </select>
                                    </div>
                                    <div className="col-span-2">
                                        <label className="text-xs font-medium text-slate-500">Area Served</label>
                                        <input type="text" className="w-full p-2 border rounded" placeholder="e.g. Sales Floor" value={unit.areaServed} onChange={(e) => updateUnit(unit.id, 'areaServed', e.target.value)} />
                                    </div>
                                </div>
                                <div className="mt-4">
                                    <label className="block text-xs font-medium text-slate-500 mb-2">Photos (Nameplate, Issues)</label>
                                    <div className="flex flex-wrap gap-2">
                                        {unit.photos.map((p, i) => (
                                            <img key={i} src={p} className="w-16 h-16 object-cover rounded border" alt="Unit" />
                                        ))}
                                        <label className="w-16 h-16 flex items-center justify-center border-2 border-dashed border-slate-300 rounded cursor-pointer hover:bg-slate-50">
                                            <Icons.Camera className="text-slate-400" />
                                            <input type="file" accept="image/*" className="hidden" onChange={(e) => handlePhotoUpload(unit.id, e)} />
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div className="space-y-4">
                                <div>
                                    <div className="flex justify-between items-center mb-2">
                                        <h4 className="font-semibold text-slate-700 flex items-center gap-2"><Icons.Wrench/> Drive & Belts</h4>
                                        <div className="flex text-xs bg-slate-100 rounded p-1">
                                            <button onClick={() => updateUnit(unit.id, 'driveType', 'Belt')} className={`px-2 py-1 rounded ${unit.driveType === 'Belt' ? 'bg-white shadow text-blue-600' : 'text-slate-500'}`}>Belt</button>
                                            <button onClick={() => updateUnit(unit.id, 'driveType', 'Direct')} className={`px-2 py-1 rounded ${unit.driveType === 'Direct' ? 'bg-white shadow text-blue-600' : 'text-slate-500'}`}>Direct</button>
                                        </div>
                                    </div>
                                    {unit.driveType === 'Belt' && (
                                        <div className="bg-slate-50 p-3 rounded space-y-2">
                                            {unit.belts.map((belt, idx) => (
                                                <div key={idx} className="flex gap-2 items-center">
                                                    <input type="number" placeholder="Qty" className="w-16 p-1 border rounded text-sm" value={belt.qty} onChange={(e) => updateNestedUnit(unit.id, 'belts', idx, 'qty', e.target.value)} />
                                                    <div className="flex-1">
                                                        <CreatableSelect 
                                                            className="w-full p-1 border rounded text-sm"
                                                            options={COMMON_BELTS}
                                                            value={belt.size}
                                                            onChange={(val) => updateNestedUnit(unit.id, 'belts', idx, 'size', val)}
                                                            placeholder="Size (e.g. A42)"
                                                        />
                                                    </div>
                                                    {unit.belts.length > 1 && <button onClick={() => removeNestedItem(unit.id, 'belts', idx)} className="text-red-400 hover:text-red-600"><Icons.Trash2/></button>}
                                                </div>
                                            ))}
                                            <button onClick={() => addItemToUnit(unit.id, 'belts', { size: '', qty: 1 })} className="text-xs text-blue-600 font-medium hover:underline">+ Add Belt Size</button>
                                        </div>
                                    )}
                                </div>
                                <div>
                                    <h4 className="font-semibold text-slate-700 flex items-center gap-2 mb-2"><Icons.CheckCircle/> Filters</h4>
                                    <div className="bg-slate-50 p-3 rounded space-y-2">
                                        {unit.filters.map((filter, idx) => (
                                            <div key={idx} className="flex gap-2 items-center">
                                                <input type="number" placeholder="Qty" className="w-16 p-1 border rounded text-sm" value={filter.qty} onChange={(e) => updateNestedUnit(unit.id, 'filters', idx, 'qty', e.target.value)} />
                                                <div className="flex-1">
                                                    <CreatableSelect 
                                                        className="w-full p-1 border rounded text-sm"
                                                        options={COMMON_FILTERS}
                                                        value={filter.size}
                                                        onChange={(val) => updateNestedUnit(unit.id, 'filters', idx, 'size', val)}
                                                        placeholder="Size (e.g. 20x20x2)"
                                                    />
                                                </div>
                                                {unit.filters.length > 1 && <button onClick={() => removeNestedItem(unit.id, 'filters', idx)} className="text-red-400 hover:text-red-600"><Icons.Trash2/></button>}
                                            </div>
                                        ))}
                                        <button onClick={() => addItemToUnit(unit.id, 'filters', { size: '', qty: 1, type: 'Pleated' })} className="text-xs text-blue-600 font-medium hover:underline">+ Add Filter Size</button>
                                    </div>
                                </div>
                                <div>
                                    <h4 className="font-semibold text-slate-700 flex items-center gap-2 mb-2"><Icons.AlertTriangle/> Access & Labor</h4>
                                    <div className="grid grid-cols-3 gap-2">
                                        <div className="col-span-2">
                                            <label className="text-xs text-slate-500">Access Notes</label>
                                            <input type="text" placeholder="Ladder, hatch..." className="w-full p-2 border rounded text-sm" value={unit.accessNotes} onChange={(e) => updateUnit(unit.id, 'accessNotes', e.target.value)} />
                                        </div>
                                        <div>
                                            <label className="text-xs text-slate-500">Extra Hrs</label>
                                            <input type="number" step="0.5" className="w-full p-2 border rounded text-sm" value={unit.laborMultiplier} onChange={(e) => updateUnit(unit.id, 'laborMultiplier', e.target.value)} />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </Card>
            );
        };

        function HVACSurveyApp() {
            const [activeTab, setActiveTab] = useState('customer');
            const [showPrintView, setShowPrintView] = useState(false);
            
            // Auth & Data State
            const [user, setUser] = useState(null);
            const [currentSurveyId, setCurrentSurveyId] = useState(null);
            const [savedSurveys, setSavedSurveys] = useState([]);
            const [showLoadModal, setShowLoadModal] = useState(false);
            const [isSaving, setIsSaving] = useState(false);
            const [isLoadingData, setIsLoadingData] = useState(false);

            // App Data State
            const [customer, setCustomer] = useState({
                name: '',
                address: '',
                contactName: '',
                phone: '',
                email: '',
                date: new Date().toISOString().split('T')[0]
            });

            const [units, setUnits] = useState([]);
            
            const [pricingConfig, setPricingConfig] = useState({
                pricePerTon: 35,
                laborRate: 125,
                coilCleanerCost: 25,
                filterMarkup: 1.5,
                beltMarkup: 1.5,
                tripCharge: 75,
                taxRate: 0.06
            });

            const [supplies, setSupplies] = useState({
                coilCleanerQty: 0,
                rags: 0,
                grease: 0
            });

            // --- AUTH LISTENERS ---
            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged((currentUser) => {
                    setUser(currentUser);
                    if (currentUser) {
                        fetchSavedSurveys(currentUser.uid);
                    } else {
                        setSavedSurveys([]);
                        setCurrentSurveyId(null);
                    }
                });
                return () => unsubscribe();
            }, []);

            // --- FIREBASE ACTIONS ---
            const handleSignIn = async () => {
                try {
                    await auth.signInWithPopup(googleProvider);
                } catch (error) {
                    console.error("Error signing in", error);
                    alert("Error signing in: " + error.message);
                }
            };

            const handleSignOut = async () => {
                try {
                    await auth.signOut();
                } catch (error) {
                    console.error("Error signing out", error);
                }
            };

            const saveSurvey = async () => {
                if (!user) return alert("Please sign in to save surveys.");
                setIsSaving(true);
                
                const surveyData = {
                    customer,
                    units,
                    pricingConfig,
                    supplies,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    userId: user.uid
                };

                try {
                    if (currentSurveyId) {
                        // Update existing
                        await db.collection('users').doc(user.uid).collection('surveys').doc(currentSurveyId).update(surveyData);
                        alert("Survey updated successfully!");
                    } else {
                        // Create new
                        const docRef = await db.collection('users').doc(user.uid).collection('surveys').add({
                            ...surveyData,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        setCurrentSurveyId(docRef.id);
                        alert("New survey saved successfully!");
                    }
                    fetchSavedSurveys(user.uid);
                } catch (error) {
                    console.error("Error saving survey", error);
                    alert("Error saving: " + error.message);
                } finally {
                    setIsSaving(false);
                }
            };

            const fetchSavedSurveys = async (uid) => {
                setIsLoadingData(true);
                try {
                    const snapshot = await db.collection('users').doc(uid).collection('surveys').orderBy('updatedAt', 'desc').get();
                    const surveys = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    setSavedSurveys(surveys);
                } catch (error) {
                    console.error("Error fetching surveys", error);
                } finally {
                    setIsLoadingData(false);
                }
            };

            const loadSurvey = (survey) => {
                if (confirm("Loading this survey will overwrite your current unsaved changes. Continue?")) {
                    setCustomer(survey.customer);
                    setUnits(survey.units || []);
                    setPricingConfig(survey.pricingConfig);
                    setSupplies(survey.supplies);
                    setCurrentSurveyId(survey.id);
                    setShowLoadModal(false);
                }
            };

            const deleteSurvey = async (surveyId, e) => {
                e.stopPropagation();
                if (confirm("Are you sure you want to delete this saved survey? This cannot be undone.")) {
                    try {
                        await db.collection('users').doc(user.uid).collection('surveys').doc(surveyId).delete();
                        if (currentSurveyId === surveyId) setCurrentSurveyId(null);
                        fetchSavedSurveys(user.uid);
                    } catch (error) {
                        console.error("Error deleting", error);
                    }
                }
            };

            const startNewSurvey = () => {
                if (confirm("Start a new survey? Any unsaved changes will be lost.")) {
                    setCurrentSurveyId(null);
                    setUnits([]);
                    setCustomer({
                        name: '',
                        address: '',
                        contactName: '',
                        phone: '',
                        email: '',
                        date: new Date().toISOString().split('T')[0]
                    });
                    setSupplies({ coilCleanerQty: 0, rags: 0, grease: 0 });
                }
            };

            // --- APP HANDLERS ---
            const addUnit = () => {
                const newUnit = {
                    id: Date.now(),
                    tag: `RTU-${units.length + 1}`,
                    brand: '',
                    model: '',
                    serial: '',
                    areaServed: '',
                    tonnage: 0,
                    refrigerant: 'R-410A',
                    driveType: 'Belt',
                    belts: [{ size: '', qty: 1 }],
                    filters: [{ size: '', qty: 1, type: 'Pleated' }],
                    condition: 'Good',
                    accessNotes: '',
                    laborMultiplier: 0,
                    photos: [] 
                };
                setUnits([...units, newUnit]);
            };

            const updateUnit = (id, field, value) => {
                setUnits(units.map(u => u.id === id ? { ...u, [field]: value } : u));
            };

            const updateNestedUnit = (unitId, arrayName, index, field, value) => {
                setUnits(units.map(u => {
                    if (u.id !== unitId) return u;
                    const newArray = [...u[arrayName]];
                    newArray[index] = { ...newArray[index], [field]: value };
                    return { ...u, [arrayName]: newArray };
                }));
            };

            const addItemToUnit = (unitId, arrayName, itemTemplate) => {
                setUnits(units.map(u => {
                    if (u.id !== unitId) return u;
                    return { ...u, [arrayName]: [...u[arrayName], itemTemplate] };
                }));
            };

            const removeNestedItem = (unitId, arrayName, index) => {
                setUnits(units.map(u => {
                    if (u.id !== unitId) return u;
                    return { ...u, [arrayName]: u[arrayName].filter((_, i) => i !== index) };
                }));
            };

            const deleteUnit = (id) => {
                if(confirm("Are you sure you want to delete this unit?")) {
                    setUnits(units.filter(u => u.id !== id));
                }
            };

            const handlePhotoUpload = (id, e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        setUnits(units.map(u => u.id === id ? { ...u, photos: [...u.photos, reader.result] } : u));
                    };
                    reader.readAsDataURL(file);
                }
            };

            // --- CALCULATIONS ---
            const calculateTotals = () => {
                let totalTonnage = 0;
                let totalFilters = {};
                let totalBelts = {};
                
                units.forEach(u => {
                    totalTonnage += parseFloat(u.tonnage) || 0;
                    u.filters.forEach(f => {
                        const key = `${f.size} (${f.type})`;
                        totalFilters[key] = (totalFilters[key] || 0) + parseInt(f.qty || 0);
                    });
                    if (u.driveType === 'Belt') {
                        u.belts.forEach(b => {
                            const key = b.size;
                            if(key) totalBelts[key] = (totalBelts[key] || 0) + parseInt(b.qty || 0);
                        });
                    }
                });
                return { totalTonnage, totalFilters, totalBelts };
            };

            const calculatePricing = () => {
                const { totalTonnage } = calculateTotals();
                const basePM = totalTonnage * pricingConfig.pricePerTon;
                const chemicalCost = supplies.coilCleanerQty * pricingConfig.coilCleanerCost;
                const extraLaborHours = units.reduce((acc, u) => acc + (parseFloat(u.laborMultiplier) || 0), 0);
                const extraLaborCost = extraLaborHours * pricingConfig.laborRate;
                const estFilterCost = units.reduce((acc, u) => acc + (u.filters.reduce((s, f) => s + f.qty, 0) * 8), 0);
                const estBeltCost = units.reduce((acc, u) => acc + (u.driveType === 'Belt' ? u.belts.reduce((s, b) => s + b.qty, 0) * 15 : 0), 0);
                const costPerVisit = basePM + extraLaborCost + chemicalCost + (estFilterCost * pricingConfig.filterMarkup) + (estBeltCost * pricingConfig.beltMarkup) + pricingConfig.tripCharge;

                return {
                    quarterly: (costPerVisit * 4).toFixed(2),
                    semiAnnual: (costPerVisit * 2 * 1.05).toFixed(2), 
                    annual: (costPerVisit * 1.10).toFixed(2),
                    perVisit: costPerVisit.toFixed(2),
                    breakdown: { basePM, extraLaborCost, materials: (estFilterCost * pricingConfig.filterMarkup) + (estBeltCost * pricingConfig.beltMarkup) + chemicalCost }
                };
            };

            const totals = calculateTotals();
            const prices = calculatePricing();

            // --- RENDER HELPERS ---
            // UnitCard has been moved out of here

            // --- PRINT VIEW ---
            if (showPrintView) {
                const today = new Date().toLocaleDateString();
                const proposalMessage = `Dear ${customer.contactName || 'Valued Customer'},

Thank you for giving HVACPro the opportunity to survey the HVAC equipment at ${customer.name || customer.address || 'your facility'}. 

Our team has completed a thorough inspection of your ${units.length} units. Based on our findings, we have developed a comprehensive maintenance plan tailored to keep your systems running efficiently, extend their lifespan, and reduce unexpected breakdowns.

Below you will find a detailed inventory of your equipment, a summary of the required materials (filters, belts, etc.), and our proposed service agreement options.

We look forward to partnering with you to maintain a comfortable and safe environment for your building.`;

                return (
                    <div className="bg-white min-h-screen text-slate-800 p-8 font-sans max-w-5xl mx-auto">
                        <div className="fixed top-4 right-4 no-print flex gap-2">
                            <Button onClick={() => window.print()} variant="primary"><Icons.Printer/> Print/PDF</Button>
                            <Button onClick={() => setShowPrintView(false)} variant="secondary">Close</Button>
                        </div>
                        <div className="border-b-2 border-slate-800 pb-4 mb-8 flex justify-between items-end">
                            <div>
                                <h1 className="text-3xl font-bold uppercase tracking-wide text-slate-900">Site Survey & Proposal</h1>
                                <p className="text-slate-500 mt-1">Commercial HVAC Assessment</p>
                            </div>
                            <div className="text-right">
                                <h2 className="text-xl font-bold">{customer.name}</h2>
                                <p className="text-sm">{customer.address}</p>
                                <p className="text-sm">{customer.contactName} | {customer.phone}</p>
                                <p className="text-sm text-slate-400 mt-2">Date: {customer.date}</p>
                            </div>
                        </div>

                        {/* THANK YOU MESSAGE */}
                        <div className="mb-8 p-6 bg-slate-50 border border-slate-200 rounded-lg whitespace-pre-wrap leading-relaxed text-slate-700">
                            {proposalMessage}
                        </div>

                        <div className="mb-8 p-4 bg-slate-100 rounded border border-slate-200">
                            <h3 className="font-bold text-lg mb-2 border-b border-slate-300 pb-1">Executive Summary</h3>
                            <div className="grid grid-cols-4 gap-4 text-center">
                                <div className="p-2"><span className="block text-2xl font-bold text-blue-600">{units.length}</span><span className="text-xs uppercase text-slate-500">Total Units</span></div>
                                <div className="p-2"><span className="block text-2xl font-bold text-blue-600">{totals.totalTonnage}</span><span className="text-xs uppercase text-slate-500">Total Tonnage</span></div>
                                <div className="p-2"><span className="block text-2xl font-bold text-blue-600">{Object.values(totals.totalFilters).reduce((a,b)=>a+b, 0)}</span><span className="text-xs uppercase text-slate-500">Total Filters</span></div>
                                <div className="p-2"><span className="block text-2xl font-bold text-blue-600">{Object.values(totals.totalBelts).reduce((a,b)=>a+b, 0)}</span><span className="text-xs uppercase text-slate-500">Total Belts</span></div>
                            </div>
                        </div>
                        <div className="mb-8">
                            <h3 className="font-bold text-lg mb-4 bg-slate-800 text-white p-2">Unit Inventory</h3>
                            <table className="w-full text-sm text-left border-collapse">
                                <thead>
                                    <tr className="border-b-2 border-slate-300">
                                        <th className="py-2">Tag</th>
                                        <th className="py-2">Model/Serial</th>
                                        <th className="py-2">Area</th>
                                        <th className="py-2">Filters</th>
                                        <th className="py-2">Belts</th>
                                        <th className="py-2">Notes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {units.map((u, i) => (
                                        <tr key={i} className="border-b border-slate-100 hover:bg-slate-50 break-inside-avoid">
                                            <td className="py-3 font-bold align-top">{u.tag}<br/><span className="text-xs font-normal text-slate-500">{u.brand} - {u.tonnage}T</span></td>
                                            <td className="py-3 align-top"><div className="text-xs">M: {u.model}</div><div className="text-xs text-slate-500">S: {u.serial}</div></td>
                                            <td className="py-3 align-top">{u.areaServed}</td>
                                            <td className="py-3 align-top">{u.filters.map((f, fi) => <div key={fi}>{f.qty} x {f.size}</div>)}</td>
                                            <td className="py-3 align-top">{u.driveType === 'Direct' ? 'Direct Drive' : u.belts.map((b, bi) => <div key={bi}>{b.qty} x {b.size}</div>)}</td>
                                            <td className="py-3 align-top italic text-slate-500">{u.accessNotes}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-8 mb-8 break-inside-avoid">
                            <div><h3 className="font-bold text-md mb-2 border-b border-slate-300 pb-1">Required Filters</h3><ul className="text-sm space-y-1">{Object.entries(totals.totalFilters).map(([size, qty]) => (<li key={size} className="flex justify-between border-b border-dashed border-slate-200 py-1"><span>{size}</span><span className="font-bold">{qty}</span></li>))}</ul></div>
                            <div><h3 className="font-bold text-md mb-2 border-b border-slate-300 pb-1">Required Belts</h3><ul className="text-sm space-y-1">{Object.entries(totals.totalBelts).map(([size, qty]) => (<li key={size} className="flex justify-between border-b border-dashed border-slate-200 py-1"><span>{size}</span><span className="font-bold">{qty}</span></li>))}</ul></div>
                            
                            {/* BULK SUPPLIES SUMMARY */}
                            <div>
                                <h3 className="font-bold text-md mb-2 border-b border-slate-300 pb-1">Bulk Supplies</h3>
                                <ul className="text-sm space-y-1">
                                    {supplies.coilCleanerQty > 0 && (
                                        <li className="flex justify-between border-b border-dashed border-slate-200 py-1">
                                            <span>Coil Cleaner</span>
                                            <div className="text-right">
                                                <span className="font-bold block">{supplies.coilCleanerQty} Gal</span>
                                                <span className="text-xs text-slate-500">${(supplies.coilCleanerQty * pricingConfig.coilCleanerCost).toFixed(2)}</span>
                                            </div>
                                        </li>
                                    )}
                                    {supplies.coilCleanerQty === 0 && <li className="text-slate-400 italic">No bulk supplies added.</li>}
                                </ul>
                            </div>
                        </div>
                        <div className="mt-8 break-inside-avoid">
                            <h3 className="font-bold text-lg mb-4 bg-slate-800 text-white p-2">Proposed Maintenance Agreements</h3>
                            <div className="grid grid-cols-3 gap-4">
                                <div className="border rounded-lg p-4 text-center bg-slate-50"><h4 className="font-bold text-slate-600 mb-2">Quarterly</h4><div className="text-3xl font-bold text-blue-700">${prices.quarterly}</div><p className="text-xs text-slate-400 mt-1">Total Annual Cost</p></div>
                                <div className="border rounded-lg p-4 text-center border-blue-200 bg-blue-50 shadow-sm relative overflow-hidden"><div className="absolute top-0 right-0 bg-blue-500 text-white text-[10px] px-2 py-1">RECOMMENDED</div><h4 className="font-bold text-blue-800 mb-2">Semi-Annual</h4><div className="text-3xl font-bold text-blue-700">${prices.semiAnnual}</div><p className="text-xs text-slate-400 mt-1">Total Annual Cost</p></div>
                                <div className="border rounded-lg p-4 text-center bg-slate-50"><h4 className="font-bold text-slate-600 mb-2">Annual</h4><div className="text-3xl font-bold text-blue-700">${prices.annual}</div><p className="text-xs text-slate-400 mt-1">Total Annual Cost</p></div>
                            </div>
                        </div>
                        {units.some(u => u.photos.length > 0) && (
                            <div className="mt-12 break-before-page">
                                <h3 className="font-bold text-lg mb-4 border-b">Site Photos</h3>
                                <div className="grid grid-cols-3 gap-4">
                                    {units.map(u => u.photos.map((p, i) => (<div key={`${u.id}-${i}`} className="border rounded p-2"><img src={p} className="w-full h-48 object-cover rounded mb-2" /><p className="text-xs font-bold text-center">{u.tag} - {u.model}</p></div>)))}
                                </div>
                            </div>
                        )}
                    </div>
                );
            }

            // --- MAIN UI ---
            return (
                <div>
                    <nav className="bg-slate-800 text-white p-4 sticky top-0 z-10 shadow-lg no-print">
                        <div className="max-w-4xl mx-auto flex justify-between items-center">
                            <div className="flex items-center gap-2">
                                <img src="https://imageview.replit.app/objects/uploads/d16ab63e-1d1e-4b8f-863c-67e66e4894fc" alt="Logo" className="h-8 w-auto mr-2"/>
                                <h1 className="font-bold text-lg tracking-tight hidden sm:block">HVAC<span className="text-blue-400">Pro</span> Survey</h1>
                            </div>
                            <div className="flex items-center gap-2">
                                {!user ? (
                                    <Button onClick={handleSignIn} variant="google" className="text-xs sm:text-sm py-1"><Icons.LogIn/> Sign In</Button>
                                ) : (
                                    <div className="flex items-center gap-3">
                                        <div className="flex flex-col items-end mr-2"><span className="text-xs text-blue-200 font-bold">{user.displayName || user.email}</span><button onClick={handleSignOut} className="text-[10px] text-slate-400 hover:text-white flex items-center gap-1"><Icons.LogOut/> Sign Out</button></div>
                                        {user.photoURL && <img src={user.photoURL} alt="Profile" className="w-8 h-8 rounded-full border border-slate-600" />}
                                        <div className="h-6 w-px bg-slate-600 mx-1"></div>
                                        <Button variant="success" onClick={saveSurvey} disabled={isSaving} className="text-xs sm:text-sm py-1">{isSaving ? <Icons.Loader className="animate-spin"/> : <Icons.Cloud/>} <span className="hidden sm:inline">Save</span></Button>
                                        <Button variant="secondary" onClick={() => setShowLoadModal(true)} className="text-xs sm:text-sm py-1 bg-slate-700 text-white border-none hover:bg-slate-600"><Icons.Download/> <span className="hidden sm:inline">Load</span></Button>
                                        <div className="h-6 w-px bg-slate-600 mx-1"></div>
                                        <Button variant="primary" onClick={startNewSurvey} className="text-xs sm:text-sm py-1 bg-slate-700 hover:bg-slate-600 border-none"><Icons.Plus/> <span className="hidden sm:inline">New</span></Button>
                                    </div>
                                )}
                                <div className="ml-2"><Button variant="primary" onClick={() => setShowPrintView(true)} className="text-xs sm:text-sm py-1"><Icons.FileText/> Report</Button></div>
                            </div>
                        </div>
                    </nav>

                    {showLoadModal && (
                        <div className="fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4">
                            <div className="bg-white rounded-lg shadow-xl w-full max-w-lg overflow-hidden flex flex-col max-h-[80vh]">
                                <div className="p-4 border-b flex justify-between items-center bg-slate-50"><h3 className="font-bold text-lg">Load Saved Survey</h3><button onClick={() => setShowLoadModal(false)} className="text-slate-400 hover:text-slate-600">✕</button></div>
                                <div className="p-4 overflow-y-auto flex-1">
                                    {isLoadingData ? <div className="flex justify-center p-8"><Icons.Loader className="animate-spin text-blue-600"/></div> : savedSurveys.length === 0 ? <p className="text-center text-slate-400 py-8">No saved surveys found.</p> : (
                                        <div className="space-y-2">
                                            {savedSurveys.map(survey => (
                                                <div key={survey.id} onClick={() => loadSurvey(survey)} className="border p-3 rounded-lg hover:bg-blue-50 cursor-pointer transition-colors flex justify-between items-center group">
                                                    <div><div className="font-bold text-slate-800">{survey.customer.name || 'Untitled Survey'}</div><div className="text-xs text-slate-500">{survey.units?.length || 0} Units • Updated: {new Date(survey.updatedAt?.seconds * 1000).toLocaleDateString()}</div></div>
                                                    <button onClick={(e) => deleteSurvey(survey.id, e)} className="p-2 text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"><Icons.Trash2/></button>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="max-w-4xl mx-auto p-4">
                        <div className="flex gap-2 mb-6 overflow-x-auto pb-2 no-print">
                            {[{ id: 'customer', label: 'Customer', icon: Icons.Users }, { id: 'units', label: 'Units', icon: Icons.Settings }, { id: 'supplies', label: 'Supplies', icon: Icons.Wrench }, { id: 'totals', label: 'Totals & Price', icon: Icons.Calculator }].map(tab => (
                                <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`flex items-center gap-2 px-4 py-3 rounded-lg font-medium whitespace-nowrap transition-all ${activeTab === tab.id ? 'bg-white shadow text-blue-600' : 'text-slate-500 hover:bg-white/50'}`}><tab.icon /> {tab.label}</button>
                            ))}
                        </div>

                        <div className="space-y-6">
                            {activeTab === 'customer' && (
                                <Card className="p-6">
                                    <h2 className="text-xl font-bold mb-4 flex items-center gap-2"><Icons.Users className="text-blue-600"/> Customer Details</h2>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div className="col-span-2"><label className="block text-sm font-medium mb-1">Company / Building</label><input type="text" className="w-full p-2 border rounded" value={customer.name} onChange={e => setCustomer({...customer, name: e.target.value})} placeholder="e.g. Skyline Plaza" /></div>
                                        <div className="col-span-2"><label className="block text-sm font-medium mb-1">Address</label><input type="text" className="w-full p-2 border rounded" value={customer.address} onChange={e => setCustomer({...customer, address: e.target.value})} placeholder="1234 Airflow Lane" /></div>
                                        <div><label className="block text-sm font-medium mb-1">Contact Name</label><input type="text" className="w-full p-2 border rounded" value={customer.contactName} onChange={e => setCustomer({...customer, contactName: e.target.value})} placeholder="John Doe" /></div>
                                        <div><label className="block text-sm font-medium mb-1">Phone</label><input type="tel" className="w-full p-2 border rounded" value={customer.phone} onChange={e => setCustomer({...customer, phone: e.target.value})} placeholder="(555) 123-4567" /></div>
                                        <div><label className="block text-sm font-medium mb-1">Email</label><input type="email" className="w-full p-2 border rounded" value={customer.email} onChange={e => setCustomer({...customer, email: e.target.value})} placeholder="john@example.com" /></div>
                                        <div><label className="block text-sm font-medium mb-1">Survey Date</label><input type="date" className="w-full p-2 border rounded" value={customer.date} onChange={e => setCustomer({...customer, date: e.target.value})} /></div>
                                    </div>
                                    <div className="mt-6 flex justify-end"><Button onClick={() => setActiveTab('units')}>Next: Add Units &rarr;</Button></div>
                                </Card>
                            )}

                            {activeTab === 'units' && (
                                <div className="space-y-4">
                                    <div className="flex justify-between items-center mb-2"><h2 className="text-xl font-bold text-slate-700">Unit Inventory ({units.length})</h2><Button onClick={addUnit} variant="primary"><Icons.Plus/> Add Unit</Button></div>
                                    {units.length === 0 && <div className="text-center p-12 bg-white rounded-lg border-2 border-dashed border-slate-300 text-slate-400"><Icons.Settings className="mx-auto mb-2 opacity-50"/><p>No units added yet. Tap "Add Unit" to begin.</p></div>}
                                    
                                    {units.map((unit) => (
                                        <UnitCard 
                                            key={unit.id} 
                                            unit={unit} 
                                            updateUnit={updateUnit}
                                            updateNestedUnit={updateNestedUnit}
                                            addItemToUnit={addItemToUnit}
                                            removeNestedItem={removeNestedItem}
                                            deleteUnit={deleteUnit}
                                            handlePhotoUpload={handlePhotoUpload}
                                        />
                                    ))}
                                    
                                    {units.length > 0 && <div className="flex justify-between mt-6"><Button variant="secondary" onClick={() => setActiveTab('customer')}>&larr; Back</Button><Button onClick={() => setActiveTab('supplies')}>Next: Supplies &rarr;</Button></div>}
                                </div>
                            )}

                            {activeTab === 'supplies' && (
                                <div className="space-y-6">
                                    <Card className="p-6">
                                        <h2 className="text-lg font-bold mb-4 flex items-center gap-2"><Icons.Wrench/> Bulk Supplies Calculator</h2>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6"><div className="bg-slate-50 p-4 rounded border"><label className="block text-sm font-semibold mb-2">Coil Cleaner (Gallons)</label><div className="flex items-center gap-2"><input type="number" className="p-2 border rounded w-24" value={supplies.coilCleanerQty} onChange={(e) => setSupplies({...supplies, coilCleanerQty: Number(e.target.value)})} /><span className="text-sm text-slate-500">x ${pricingConfig.coilCleanerCost}/gal = <span className="font-bold text-slate-800">${(supplies.coilCleanerQty * pricingConfig.coilCleanerCost).toFixed(2)}</span></span></div></div></div>
                                    </Card>
                                    <Card className="p-6 border-orange-200">
                                        <h2 className="text-lg font-bold mb-4 flex items-center gap-2 text-slate-700"><Icons.Settings/> Pricing Configuration</h2>
                                        <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                                            <div><label className="block text-xs font-bold text-slate-500 uppercase">Price Per Ton</label><input type="number" className="w-full p-2 border rounded" value={pricingConfig.pricePerTon} onChange={(e) => setPricingConfig({...pricingConfig, pricePerTon: Number(e.target.value)})} /></div>
                                            <div><label className="block text-xs font-bold text-slate-500 uppercase">Labor Rate / Hr</label><input type="number" className="w-full p-2 border rounded" value={pricingConfig.laborRate} onChange={(e) => setPricingConfig({...pricingConfig, laborRate: Number(e.target.value)})} /></div>
                                            <div><label className="block text-xs font-bold text-slate-500 uppercase">Trip Charge</label><input type="number" className="w-full p-2 border rounded" value={pricingConfig.tripCharge} onChange={(e) => setPricingConfig({...pricingConfig, tripCharge: Number(e.target.value)})} /></div>
                                        </div>
                                    </Card>
                                    <div className="flex justify-between mt-6"><Button variant="secondary" onClick={() => setActiveTab('units')}>&larr; Back</Button><Button onClick={() => setActiveTab('totals')}>Next: Totals &rarr;</Button></div>
                                </div>
                            )}

                            {activeTab === 'totals' && (
                                <div className="space-y-6">
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <Card className="p-4"><h3 className="font-bold text-slate-700 border-b pb-2 mb-2">Total Filters Needed</h3>{Object.keys(totals.totalFilters).length === 0 ? <p className="text-slate-400 italic">No filters recorded.</p> : <ul className="space-y-2">{Object.entries(totals.totalFilters).map(([size, qty]) => <li key={size} className="flex justify-between bg-slate-50 p-2 rounded"><span className="font-mono text-sm">{size}</span><span className="font-bold bg-blue-100 text-blue-800 px-2 rounded-full">{qty}</span></li>)}</ul>}</Card>
                                        <Card className="p-4"><h3 className="font-bold text-slate-700 border-b pb-2 mb-2">Total Belts Needed</h3>{Object.keys(totals.totalBelts).length === 0 ? <p className="text-slate-400 italic">No belts recorded.</p> : <ul className="space-y-2">{Object.entries(totals.totalBelts).map(([size, qty]) => <li key={size} className="flex justify-between bg-slate-50 p-2 rounded"><span className="font-mono text-sm">{size}</span><span className="font-bold bg-orange-100 text-orange-800 px-2 rounded-full">{qty}</span></li>)}</ul>}</Card>
                                        <Card className="p-4"><h3 className="font-bold text-slate-700 border-b pb-2 mb-2">Bulk Supplies</h3>{supplies.coilCleanerQty === 0 ? <p className="text-slate-400 italic">No bulk supplies.</p> : <ul className="space-y-2"><li className="flex justify-between bg-slate-50 p-2 rounded"><span className="font-mono text-sm">Coil Cleaner</span><div className="text-right"><span className="font-bold bg-emerald-100 text-emerald-800 px-2 rounded-full">{supplies.coilCleanerQty} Gal</span><div className="text-xs text-slate-500 mt-1">${(supplies.coilCleanerQty * pricingConfig.coilCleanerCost).toFixed(2)}</div></div></li></ul>}</Card>
                                    </div>
                                    <Card className="p-6 bg-slate-800 text-white">
                                        <h2 className="text-xl font-bold mb-6">Estimated Maintenance Costs</h2>
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
                                            <div className="bg-slate-700 p-4 rounded-lg"><div className="text-sm text-slate-300 mb-1">Quarterly (4x)</div><div className="text-3xl font-bold text-green-400">${prices.quarterly}</div></div>
                                            <div className="bg-slate-700 p-4 rounded-lg border-2 border-blue-500 relative"><div className="absolute top-0 right-0 bg-blue-500 text-xs px-2 py-0.5">Popular</div><div className="text-sm text-slate-300 mb-1">Semi-Annual (2x)</div><div className="text-3xl font-bold text-green-400">${prices.semiAnnual}</div></div>
                                            <div className="bg-slate-700 p-4 rounded-lg"><div className="text-sm text-slate-300 mb-1">Annual (1x)</div><div className="text-3xl font-bold text-green-400">${prices.annual}</div></div>
                                        </div>
                                    </Card>
                                    <div className="flex justify-center mt-8 pb-8"><Button onClick={() => setShowPrintView(true)} variant="success" className="px-8 py-4 text-lg shadow-xl"><Icons.FileText/> Generate Report & Proposal</Button></div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<HVACSurveyApp />);
    </script>
</body>
</html>
