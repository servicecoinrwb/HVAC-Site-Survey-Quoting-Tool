<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HVAC Site Survey Tool</title>
    
    <!-- Tailwind CSS (CDN is required for this standalone single-file tool) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Alpine.js -->
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    
    <style>
        body { font-family: 'Inter', system-ui, sans-serif; background-color: #f3f4f6; }
        [x-cloak] { display: none !important; } /* Hides elements until Alpine loads */
        
        /* Standard clean input styles */
        .input-std { 
            @apply mt-1 block w-full rounded-md border-gray-300 shadow-sm text-sm py-2 px-3 border focus:border-sky-500 focus:ring-sky-500 bg-white; 
        }
        .label-std { 
            @apply block text-xs font-semibold text-gray-600 uppercase tracking-wide mb-1; 
        }
    </style>
</head>

<body class="p-4 md:p-8" x-data="hvacApp" x-cloak>

    <div class="max-w-6xl mx-auto pb-20">
        
        <!-- HEADER -->
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 border-b pb-4 bg-white p-6 rounded-xl shadow-sm">
            <div>
                <h1 class="text-3xl font-extrabold text-gray-800 tracking-tight">HVAC Site Survey</h1>
                <p class="text-sm text-gray-500 mt-1">Commercial Estimation & Asset Tagging</p>
            </div>
            
            <!-- Auth Status -->
            <div class="mt-4 md:mt-0 flex items-center space-x-3">
                <template x-if="!user">
                    <button @click="signIn" class="flex items-center px-4 py-2 bg-sky-600 text-white font-medium rounded-lg shadow hover:bg-sky-700 transition">
                        <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="currentColor"><path d="M12.545,10.239v3.821h5.445c-0.712,2.315-2.647,3.972-5.445,3.972c-3.332,0-6.033-2.701-6.033-6.033-6.032s2.701-6.032,6.033-6.032c1.498,0,2.866,0.549,3.921,1.453l2.814-2.814C17.503,2.988,15.139,2,12.545,2C7.021,2,2.543,6.477,2.543,12s4.478,10,10.002,10c8.396,0,10.249-7.85,9.426-11.748L12.545,10.239z"/></svg>
                        Sign in with Google
                    </button>
                </template>
                <template x-if="user">
                    <div class="flex items-center bg-green-50 px-3 py-1.5 rounded-full border border-green-200">
                        <div class="w-2 h-2 bg-green-500 rounded-full mr-2 animate-pulse"></div>
                        <span class="text-xs font-medium text-green-800" x-text="user.email"></span>
                    </div>
                </template>
            </div>
        </div>

        <!-- AUTH LOCK OVERLAY -->
        <div x-show="!user" class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6 rounded-r shadow-sm">
            <div class="flex">
                <div class="ml-3">
                    <p class="text-sm text-yellow-700">
                        You are in <strong>Read-Only Mode</strong>. Sign in to Save/Load surveys.
                    </p>
                </div>
            </div>
        </div>

        <!-- MAIN FORM GRID -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <!-- LEFT COLUMN: Inputs -->
            <div class="lg:col-span-2 space-y-6">

                <!-- SECTION 1: Site Information (Clean Layout) -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 space-y-6">
                    <h2 class="text-lg font-bold text-gray-800 border-b pb-2 flex items-center">
                        <span class="bg-sky-100 text-sky-600 w-6 h-6 rounded flex items-center justify-center text-xs mr-2">1</span>
                        Job Information
                    </h2>
                    
                    <!-- Row 1: Primary Identifiers -->
                    <!-- Added .debounce to prevent focus jumping -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div><label class="label-std">Job #</label><input x-model.debounce.500ms="data.jobNo" type="text" class="input-std" placeholder="---"></div>
                        <div><label class="label-std">Date</label><input x-model="data.date" type="date" class="input-std"></div>
                        <div><label class="label-std">WO #</label><input x-model.debounce.500ms="data.woNo" type="text" class="input-std" placeholder="---"></div>
                    </div>

                    <!-- Row 2: Job Type Checkboxes -->
                    <div>
                        <label class="label-std mb-2">Job Type</label>
                        <div class="flex flex-wrap gap-4 bg-gray-50 p-4 rounded-lg border border-gray-200">
                            <label class="flex items-center space-x-2 text-sm text-gray-700 cursor-pointer hover:text-sky-600">
                                <input type="checkbox" x-model="data.jobTypes.serviceCall" class="text-sky-600 rounded border-gray-300 focus:ring-sky-500">
                                <span>Service Call</span>
                            </label>
                            <label class="flex items-center space-x-2 text-sm text-gray-700 cursor-pointer hover:text-sky-600">
                                <input type="checkbox" x-model="data.jobTypes.plannedMaintenance" class="text-sky-600 rounded border-gray-300 focus:ring-sky-500">
                                <span>Planned Maint.</span>
                            </label>
                            <label class="flex items-center space-x-2 text-sm text-gray-700 cursor-pointer hover:text-sky-600">
                                <input type="checkbox" x-model="data.jobTypes.emergency" class="text-sky-600 rounded border-gray-300 focus:ring-sky-500">
                                <span>Emergency</span>
                            </label>
                            <label class="flex items-center space-x-2 text-sm text-gray-700 cursor-pointer hover:text-sky-600">
                                <input type="checkbox" x-model="data.jobTypes.regular" class="text-sky-600 rounded border-gray-300 focus:ring-sky-500">
                                <span>Regular</span>
                            </label>
                            <label class="flex items-center space-x-2 text-sm text-gray-700 cursor-pointer hover:text-sky-600">
                                <input type="checkbox" x-model="data.jobTypes.warranty" class="text-sky-600 rounded border-gray-300 focus:ring-sky-500">
                                <span>Warranty</span>
                            </label>
                        </div>
                    </div>

                    <!-- Detailed Info Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        
                        <!-- Left Sub-Column: Customer Info -->
                        <div class="space-y-4">
                            <div><label class="label-std">Customer (Bill To)</label><input x-model.debounce.500ms="data.customerName" type="text" class="input-std"></div>
                            <div><label class="label-std">Billing Address</label><textarea x-model.debounce.500ms="data.billingAddress" rows="3" class="input-std"></textarea></div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="label-std">Phone</label><input x-model.debounce.500ms="data.contactPhone" type="tel" class="input-std"></div>
                                <div><label class="label-std">Cell</label><input x-model.debounce.500ms="data.contactCell" type="tel" class="input-std"></div>
                            </div>
                            <div><label class="label-std">Email</label><input x-model.debounce.500ms="data.contactEmail" type="email" class="input-std"></div>
                        </div>

                        <!-- Right Sub-Column: Work Info -->
                        <div class="space-y-4">
                            <div><label class="label-std">Complaint / Request / Access</label><textarea x-model.debounce.500ms="data.locationNotes" rows="3" class="input-std" placeholder="Door codes, specific issues, etc."></textarea></div>
                            <div><label class="label-std">Work Ordered By</label><input x-model.debounce.500ms="data.workOrderedBy" type="text" class="input-std"></div>
                            <div><label class="label-std">Address of Unit</label><input x-model.debounce.500ms="data.serviceAddress" type="text" class="input-std"></div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="label-std">Site Name / View Ref</label><input x-model.debounce.500ms="data.siteName" type="text" class="input-std"></div>
                                <div>
                                    <label class="label-std">Roof Access</label>
                                    <select x-model="data.roofAccess" class="input-std">
                                        <option>Yes</option>
                                        <option>Ladder Req.</option>
                                        <option>No</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- SECTION 2: Equipment List -->
                <div class="space-y-4">
                    <div class="flex justify-between items-end">
                        <h2 class="text-xl font-bold text-gray-800">Equipment List</h2>
                        <button @click="addUnit()" class="bg-sky-600 hover:bg-sky-700 text-white text-sm px-4 py-2 rounded-lg shadow flex items-center transition">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                            Add Unit
                        </button>
                    </div>

                    <!-- Empty State -->
                    <template x-if="data.units.length === 0">
                        <div class="text-center p-10 bg-gray-100 border-2 border-dashed border-gray-300 rounded-xl text-gray-500">
                            No units added yet. Click "Add Unit" to start.
                        </div>
                    </template>

                    <!-- UNIT CARDS -->
                    <template x-for="(unit, index) in data.units" :key="unit.id">
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden transition hover:shadow-md">
                            <div class="bg-gray-50 p-4 border-b flex justify-between items-center cursor-pointer" @click="unit.expanded = !unit.expanded">
                                <div class="flex items-center">
                                    <div class="bg-sky-600 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold mr-3" x-text="index + 1"></div>
                                    <div>
                                        <h3 class="font-bold text-gray-800" x-text="unit.brand ? (unit.brand + ' ' + unit.type) : 'New Unit'"></h3>
                                        <p class="text-xs text-gray-500" x-text="unit.model ? 'Model: ' + unit.model : 'No Model Info'"></p>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-3">
                                    <span class="text-green-600 font-bold text-sm" x-text="'$' + calculateUnitTotal(unit).toFixed(2)"></span>
                                    <button @click.stop="removeUnit(index)" class="text-red-400 hover:text-red-600 p-1">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                    </button>
                                    <svg class="w-5 h-5 text-gray-400 transform transition-transform" :class="{'rotate-180': unit.expanded}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                </div>
                            </div>

                            <!-- Unit Body -->
                            <div x-show="unit.expanded" class="p-4 grid grid-cols-1 md:grid-cols-3 gap-4 bg-white">
                                <!-- Debounced inputs to prevent header flickering focus loss -->
                                <div><label class="label-std">Type</label>
                                    <select x-model="unit.type" class="input-std">
                                        <option value="RTU">RTU</option>
                                        <option value="Split System">Split System</option>
                                        <option value="Condenser">Condenser</option>
                                        <option value="VAV">VAV</option>
                                    </select>
                                </div>
                                <div><label class="label-std">Brand</label><input x-model.debounce.500ms="unit.brand" type="text" class="input-std"></div>
                                <div><label class="label-std">Model</label><input x-model.debounce.500ms="unit.model" type="text" class="input-std"></div>
                                <div><label class="label-std">Serial</label><input x-model.debounce.500ms="unit.serialNumber" type="text" class="input-std"></div>
                                <div><label class="label-std">Tonnage</label><input x-model.debounce.500ms="unit.tonnage" type="number" class="input-std" placeholder="e.g. 5"></div>
                                <div><label class="label-std">VAV Count</label><input x-model.number.debounce.300ms="unit.vavCount" type="number" class="input-std"></div>

                                <!-- Filters & Belts -->
                                <div class="md:col-span-3 grid grid-cols-1 md:grid-cols-2 gap-4 border-t border-b py-4 my-2">
                                    <div class="bg-gray-50 p-3 rounded">
                                        <div class="flex justify-between mb-2">
                                            <label class="label-std mb-0">Filters</label>
                                            <button @click="unit.filters.push({qty:1, size:''})" class="text-xs text-sky-600 font-bold">+ Add Filter</button>
                                        </div>
                                        <template x-for="(filter, fIndex) in unit.filters" :key="fIndex">
                                            <div class="flex gap-2 mb-2">
                                                <input x-model="filter.qty" type="number" class="w-16 rounded border-gray-300 text-sm" placeholder="#">
                                                <input x-model.debounce.500ms="filter.size" type="text" class="flex-1 rounded border-gray-300 text-sm" placeholder="Size (e.g. 16x25x2)">
                                                <button @click="unit.filters.splice(fIndex, 1)" class="text-red-500 hover:text-red-700">x</button>
                                            </div>
                                        </template>
                                    </div>
                                    <div class="bg-gray-50 p-3 rounded">
                                        <div class="flex justify-between mb-2">
                                            <label class="label-std mb-0">Belts</label>
                                            <button @click="unit.belts.push({qty:1, size:''})" class="text-xs text-sky-600 font-bold">+ Add Belt</button>
                                        </div>
                                        <template x-for="(belt, bIndex) in unit.belts" :key="bIndex">
                                            <div class="flex gap-2 mb-2">
                                                <input x-model="belt.qty" type="number" class="w-16 rounded border-gray-300 text-sm" placeholder="#">
                                                <input x-model.debounce.500ms="belt.size" type="text" class="flex-1 rounded border-gray-300 text-sm" placeholder="Size (e.g. A45)">
                                                <button @click="unit.belts.splice(bIndex, 1)" class="text-red-500 hover:text-red-700">x</button>
                                            </div>
                                        </template>
                                    </div>
                                </div>

                                <!-- Pricing Fields (Debounced to stop calculator jumping) -->
                                <div class="md:col-span-3 bg-yellow-50 p-3 rounded border border-yellow-200 grid grid-cols-2 md:grid-cols-4 gap-4 items-end">
                                    <div><label class="label-std">Base PM ($)</label><input x-model.number.debounce.300ms="unit.basePMCost" type="number" class="input-std"></div>
                                    <div><label class="label-std">Cleaner Mat ($)</label><input x-model.number.debounce.300ms="unit.coilCleanerMaterial" type="number" class="input-std"></div>
                                    <div><label class="label-std">Extra Mat ($)</label><input x-model.number.debounce.300ms="unit.additionalMaterial" type="number" class="input-std"></div>
                                    <div class="flex items-center h-10">
                                        <input x-model="unit.requiresCoilClean" type="checkbox" class="h-4 w-4 text-sky-600 border-gray-300 rounded focus:ring-sky-500">
                                        <label class="ml-2 block text-sm text-gray-900">Needs Coil Wash</label>
                                    </div>
                                </div>
                                <div class="md:col-span-3">
                                    <label class="label-std">Technician Notes</label>
                                    <textarea x-model.debounce.500ms="unit.notes" rows="2" class="input-std" placeholder="Condition, access issues, etc."></textarea>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- RIGHT COLUMN: Sticky Summary -->
            <div class="lg:col-span-1">
                <div class="sticky top-6 space-y-4">
                    <!-- Cost Summary Card -->
                    <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
                        <div class="bg-gray-800 p-4">
                            <h3 class="text-white font-bold text-lg">Quote Summary</h3>
                            <p class="text-gray-400 text-xs">Based on current inputs</p>
                        </div>
                        <div class="p-6">
                            <div class="flex justify-between items-end mb-2">
                                <span class="text-gray-600 font-medium">Cost Per Visit</span>
                                <span class="text-3xl font-extrabold text-sky-600" x-text="formatCurrency(grandTotal)"></span>
                            </div>
                            <div class="text-xs text-gray-500 mb-6 border-b pb-4">
                                Includes Base Trip ($430), Unit PMs, VAVs ($15ea), and Materials.
                            </div>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between"><span>Annual (1x)</span> <span class="font-bold" x-text="formatCurrency(grandTotal)"></span></div>
                                <div class="flex justify-between"><span>Semi-Annual (2x)</span> <span class="font-bold" x-text="formatCurrency(grandTotal * 2)"></span></div>
                                <div class="flex justify-between"><span>Quarterly (4x)</span> <span class="font-bold" x-text="formatCurrency(grandTotal * 4)"></span></div>
                            </div>
                        </div>
                        <!-- Detailed Breakdown Toggle -->
                        <div class="bg-gray-50 p-4 border-t cursor-pointer" @click="showBreakdown = !showBreakdown">
                            <div class="flex justify-between text-xs font-bold text-gray-500 uppercase">
                                <span>Detailed Breakdown</span>
                                <span x-text="showBreakdown ? '-' : '+'"></span>
                            </div>
                            <div x-show="showBreakdown" class="mt-3 space-y-1 text-xs text-gray-600" x-transition>
                                <div class="flex justify-between"><span>Base Labor:</span> <span>$430.00</span></div>
                                <div class="flex justify-between"><span>Unit PM Sum:</span> <span x-text="formatCurrency(totals.unitPM)"></span></div>
                                <div class="flex justify-between"><span>VAV Add-on:</span> <span x-text="formatCurrency(totals.vav)"></span></div>
                                <div class="flex justify-between"><span>Coil Labor:</span> <span x-text="formatCurrency(totals.coilLabor)"></span></div>
                                <div class="flex justify-between"><span>Materials:</span> <span x-text="formatCurrency(totals.materials)"></span></div>
                            </div>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="grid grid-cols-2 gap-3">
                        <button @click="saveSurvey" :disabled="!user || isSaving" class="bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white font-bold py-3 px-4 rounded-lg shadow transition flex justify-center items-center">
                            <span x-show="isSaving" class="animate-spin h-4 w-4 border-2 border-white border-t-transparent rounded-full mr-2"></span>
                            Save
                        </button>
                        <button @click="fetchSurveys" :disabled="!user" class="bg-white border border-gray-300 hover:bg-gray-50 disabled:bg-gray-100 text-gray-700 font-bold py-3 px-4 rounded-lg shadow-sm transition">
                            Load
                        </button>
                        <button @click="resetForm" class="col-span-2 text-xs text-gray-500 hover:text-red-500 underline">Start New / Reset</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- LOAD MODAL -->
        <div x-show="showLoadModal" class="fixed inset-0 z-50 overflow-y-auto" style="display: none;">
            <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" @click="showLoadModal = false"></div>
                <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                    <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                        <h3 class="text-lg leading-6 font-medium text-gray-900">Saved Surveys</h3>
                        <div class="mt-4 max-h-60 overflow-y-auto space-y-2">
                            <template x-if="savedSurveys.length === 0"><p class="text-gray-500">No saved surveys found.</p></template>
                            <template x-for="survey in savedSurveys" :key="survey.id">
                                <div @click="loadSurvey(survey)" class="p-3 border rounded hover:bg-sky-50 cursor-pointer flex justify-between items-center group">
                                    <div>
                                        <div class="font-bold text-gray-700" x-text="survey.siteName || 'Unnamed'"></div>
                                        <div class="text-xs text-gray-500" x-text="new Date(survey.lastUpdated.seconds * 1000).toLocaleDateString()"></div>
                                    </div>
                                    <button class="text-sky-600 text-sm font-bold opacity-0 group-hover:opacity-100">Load</button>
                                </div>
                            </template>
                        </div>
                    </div>
                    <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                        <button type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm" @click="showLoadModal = false">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- TOAST NOTIFICATION -->
        <div x-show="toast.visible" 
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 translate-y-2"
             x-transition:enter-end="opacity-100 translate-y-0"
             x-transition:leave="transition ease-in duration-100"
             x-transition:leave-start="opacity-100"
             x-transition:leave-end="opacity-0"
             class="fixed bottom-5 right-5 px-6 py-3 rounded-lg shadow-lg text-white font-medium z-50"
             :class="toast.type === 'error' ? 'bg-red-600' : 'bg-green-600'"
             x-text="toast.message"
             style="display: none;">
        </div>

    </div>

    <!-- MAIN APP SCRIPT -->
    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('hvacApp', () => ({
                user: null,
                isSaving: false,
                showLoadModal: false,
                showBreakdown: false,
                currentDocId: null,
                savedSurveys: [],
                toast: { visible: false, message: '', type: 'success' },
                auth: null,
                db: null,
                firebaseConfig: null,

                data: {
                    jobNo: '',
                    date: new Date().toISOString().split('T')[0],
                    woNo: '',
                    companyName: 'Mechanical Temp',
                    viewRef: '',
                    customerName: '',
                    billingAddress: '',
                    contactPhone: '',
                    contactCell: '',
                    contactEmail: '',
                    workOrderedBy: '',
                    serviceAddress: '',
                    siteName: '',
                    roofAccess: 'Yes',
                    locationNotes: '',
                    jobTypes: {
                        serviceCall: false,
                        plannedMaintenance: false,
                        emergency: false,
                        regular: true,
                        warranty: false
                    },
                    units: []
                },

                async init() {
                    console.log("App initializing...");
                    if(this.data.units.length === 0) this.addUnit();

                    try {
                        const { initializeApp } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js");
                        const { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signInWithCustomToken } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js");
                        const { getFirestore, doc, setDoc, collection, query, orderBy, limit, getDocs, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");

                        this.fb = { signInWithPopup, GoogleAuthProvider, getAuth, getFirestore, doc, setDoc, collection, query, orderBy, limit, getDocs, serverTimestamp };

                        this.firebaseConfig = {
                            apiKey: "AIzaSyB3nwP6M7veF9eD9hWW5Wy1zzv1pnnaU2M",
                            authDomain: "hvac-site-survey-quoting-tool.firebaseapp.com",
                            projectId: "hvac-site-survey-quoting-tool",
                            storageBucket: "hvac-site-survey-quoting-tool.firebasestorage.app",
                            messagingSenderId: "228511119722",
                            appId: "1:228511119722:web:c2551e4ca7bd85842fcd13"
                        };

                         if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                            try {
                                const envConfig = JSON.parse(__firebase_config);
                                this.firebaseConfig = envConfig;
                                this.appIdStr = typeof __app_id !== 'undefined' ? __app_id : this.firebaseConfig.appId;
                            } catch(e) { console.error("Env config parse error", e); }
                        } else {
                            this.appIdStr = "default-app-id"; 
                        }

                        const app = initializeApp(this.firebaseConfig);
                        this.auth = getAuth(app);
                        this.db = getFirestore(app);

                        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                        if (initialAuthToken) {
                            await signInWithCustomToken(this.auth, initialAuthToken);
                        }

                        onAuthStateChanged(this.auth, (u) => {
                            this.user = u;
                            if(u && !u.isAnonymous) {
                                this.fetchSurveys();
                            }
                        });

                    } catch (e) {
                        console.error("Firebase Init Error:", e);
                        this.showToast("Failed to load database connection.", "error");
                    }
                },

                async signIn() {
                    if (!this.auth) return;
                    try {
                        const provider = new this.fb.GoogleAuthProvider();
                        await this.fb.signInWithPopup(this.auth, provider);
                    } catch (e) {
                        this.showToast(e.message, 'error');
                    }
                },

                addUnit() {
                    this.data.units.push({
                        id: Date.now(),
                        expanded: true,
                        type: 'RTU',
                        brand: '',
                        model: '',
                        serialNumber: '',
                        tonnage: null,
                        vavCount: 0,
                        filters: [{qty:1, size:''}],
                        belts: [{qty:1, size:''}],
                        basePMCost: 0,
                        coilCleanerMaterial: 0,
                        additionalMaterial: 0,
                        requiresCoilClean: false,
                        notes: ''
                    });
                },

                removeUnit(index) {
                    if(confirm("Delete this unit?")) {
                        this.data.units.splice(index, 1);
                    }
                },

                resetForm() {
                    if(confirm("Clear current form? Unsaved changes will be lost.")) {
                        this.currentDocId = null;
                        this.data.jobNo = '';
                        this.data.woNo = '';
                        this.data.companyName = 'Mechanical Temp';
                        this.data.customerName = '';
                        this.data.billingAddress = '';
                        this.data.contactPhone = '';
                        this.data.contactCell = '';
                        this.data.contactEmail = '';
                        this.data.serviceAddress = '';
                        this.data.siteName = '';
                        this.data.locationNotes = '';
                        this.data.workOrderedBy = '';
                        this.data.units = [];
                        this.addUnit();
                    }
                },

                calculateUnitTotal(unit) {
                    let cost = (unit.basePMCost || 0) + (unit.coilCleanerMaterial || 0) + (unit.additionalMaterial || 0);
                    cost += (unit.vavCount || 0) * 15;
                    if (unit.requiresCoilClean) {
                        let ton = parseFloat(unit.tonnage) || 0;
                        cost += (ton >= 10 ? 60 : 45);
                    }
                    return cost;
                },

                get totals() {
                    let t = { unitPM: 0, vav: 0, coilLabor: 0, materials: 0 };
                    this.data.units.forEach(u => {
                        t.unitPM += (u.basePMCost || 0);
                        t.vav += (u.vavCount || 0) * 15;
                        t.materials += (u.coilCleanerMaterial || 0) + (u.additionalMaterial || 0);
                        if(u.requiresCoilClean) {
                            let ton = parseFloat(u.tonnage) || 0;
                            t.coilLabor += (ton >= 10 ? 60 : 45);
                        }
                    });
                    return t;
                },

                get grandTotal() {
                    const baseTrip = 430;
                    return baseTrip + this.totals.unitPM + this.totals.vav + this.totals.coilLabor + this.totals.materials;
                },

                formatCurrency(val) {
                    return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(val || 0);
                },

                async saveSurvey() {
                    if(!this.user) return this.showToast("Please sign in first.", 'error');
                    if(!this.data.siteName) return this.showToast("Site Name is required", 'error');
                    
                    this.isSaving = true;
                    try {
                        if (!this.currentDocId) this.currentDocId = `survey-${Date.now()}`;
                        let path = `artifacts/${this.appIdStr}/users/${this.user.uid}/hvac_surveys`;
                        
                        const dataToSave = {
                            ...this.data,
                            lastUpdated: this.fb.serverTimestamp()
                        };

                        const docRef = this.fb.doc(this.db, path, this.currentDocId);
                        await this.fb.setDoc(docRef, dataToSave, { merge: true });

                        this.showToast("Saved Successfully!");
                    } catch (e) {
                        console.error(e);
                        this.showToast("Error saving data: " + e.message, 'error');
                    } finally {
                        this.isSaving = false;
                    }
                },

                async fetchSurveys() {
                    if (!this.user || !this.db) return;
                    try {
                        let path = `artifacts/${this.appIdStr}/users/${this.user.uid}/hvac_surveys`;
                        const q = this.fb.query(this.fb.collection(this.db, path), this.fb.orderBy('lastUpdated', 'desc'), this.fb.limit(10));
                        const querySnapshot = await this.fb.getDocs(q);
                        this.savedSurveys = [];
                        querySnapshot.forEach((doc) => {
                            this.savedSurveys.push({ id: doc.id, ...doc.data() });
                        });
                        if(this.savedSurveys.length > 0) this.showLoadModal = true;
                        else this.showToast("No saved surveys found.", "error");
                    } catch (e) {
                        console.error(e);
                        this.showToast("Error fetching surveys", 'error');
                    }
                },

                loadSurvey(survey) {
                    this.currentDocId = survey.id;
                    let loadedData = JSON.parse(JSON.stringify(survey));
                    delete loadedData.id;
                    delete loadedData.lastUpdated;
                    
                    // Backward compatibility defaults
                    if(!loadedData.jobTypes) loadedData.jobTypes = { regular: true };
                    if(!loadedData.units) loadedData.units = [];
                    loadedData.units = loadedData.units.map(u => ({...u, expanded: false}));

                    this.data = loadedData;
                    this.showLoadModal = false;
                    this.showToast("Survey Loaded");
                },

                showToast(msg, type = 'success') {
                    this.toast.message = msg;
                    this.toast.type = type;
                    this.toast.visible = true;
                    setTimeout(() => this.toast.visible = false, 3000);
                }
            }))
        });
    </script>
</body>
</html>
